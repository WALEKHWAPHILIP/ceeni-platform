{# templates/user_profiles/screens/s5_communication.html #}

{% extends "user_profiles/base/wizard_base.html" %}
{% load widget_tweaks %}
{% block title %}Step 5 — Communication Preferences{% endblock %}

{% block wizard_content %}
  {# — Step 5 includes: wants_bill_notifications (select), and whatsapp_opt_in_number (conditionally visible) — #}

  <div class="space-y-4">

    <!-- 🔄 HTMX Loading Indicator -->
    <div id="htmx-loading" class="hidden text-sm text-gray-500">Loading field...</div>

    <!-- 📨 Notification Opt-In Dropdown -->
    <div>
      <label for="id_wants_bill_notifications" class="block text-sm font-semibold text-gray-700 mb-1">
        {{ form.wants_bill_notifications.label }}
      </label>

      {{ form.wants_bill_notifications|add_class:"select select-bordered w-full rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-green-600" }}

      {% if form.wants_bill_notifications.help_text %}
        <p class="text-xs text-gray-500 italic mt-1">
          {{ form.wants_bill_notifications.help_text|safe }}
        </p>
      {% endif %}
      {% for error in form.wants_bill_notifications.errors %}
        <p class="text-sm text-red-600 mt-1">{{ error }}</p>
      {% endfor %}
    </div>

    <!-- 🔁 Conditional WhatsApp Field Loader via HTMX -->
    <div
      id="whatsapp-container"
      hx-post="{% url 'user_profiles:htmx_whatsapp_field' %}"
      hx-target="#whatsapp-container"
      hx-trigger="load, change from:#id_wants_bill_notifications"
      hx-swap="outerHTML"
      hx-include="#id_wants_bill_notifications"
      hx-indicator="#htmx-loading"
    >
      {% include "user_profiles/partials/_whatsapp_opt_in_field.html" %}
    </div>
  </div>
  

  {# Kenya flag separator below inputs #}
  {% include "user_profiles/partials/_kenya_flag_hr_separator.html" %}
{% endblock %}

{% block wizard_nav %}
  {# Resolve the back URL #}
  {% url 'user_profiles:screen_4' as back_url %}

  {# Left: DRY’d Back button #}
  {% include "user_profiles/partials/_wizard_back_button.html" with back_url=back_url %}

  {# Right: DRY’d Save & Continue button #}
  {% include "user_profiles/partials/_wizard_button.html" %}
{% endblock %}


